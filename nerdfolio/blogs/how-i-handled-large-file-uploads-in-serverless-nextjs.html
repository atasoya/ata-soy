<p><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Blog - Ata Atasoy</title>
<link rel="icon" href="../public/favicon.svg" type="image/svg+xml">
<link rel="stylesheet" href="../nerdfolio.css" />
<style>
  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    padding: 0;
    min-height: 100vh;
    overflow-x: hidden;
  }

  .blog-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 2rem 4rem;
    width: 100%;
  }

  .blog-content {
    line-height: 1.8;
  }

  .blog-content h2 {
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    font-size: 1.75rem;
    border-bottom: 1px solid currentColor;
    opacity: 0.9;
  }

  .blog-content h3 {
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    font-size: 1.4rem;
    border-bottom: 1px solid currentColor;
    opacity: 0.9;
  }

  .blog-content h1 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    font-size: 2rem;
    border-bottom: 1px solid currentColor;
    opacity: 0.9;
  }

  .blog-content p {
    margin: 1rem 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .blog-content img {
    max-width: 100%;
    width: 100%;
    height: auto;
    margin: 2rem auto;
    border-radius: 8px;
    display: block;
    background: none !important;
  }

  .blog-content code {
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-size: 0.9em;
    word-break: break-word;
  }

  .blog-content pre {
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
    margin: 1.5rem 0;
    max-width: 100%;
  }

  .blog-content pre code {
    word-break: normal;
  }

  .blog-content table {
    width: 100%;
    margin: 2rem 0;
    border-collapse: collapse;
  }

  .blog-content th,
  .blog-content td {
    padding: 0.75rem;
    text-align: left;
  }

  .blog-content a {
    text-decoration: underline;
  }

  .blog-header {
    text-align: center;
    padding: 3rem 1rem 1rem;
  }

  .blog-header a {
    text-decoration: none;
    color: inherit;
    display: inline-block;
    margin-bottom: 2rem;
  }

  .blog-header .site-name {
    font-size: 0.875rem;
    font-weight: 600;
    margin: 0;
  }

  .blog-footer {
    border-top: 1px solid currentColor;
    opacity: 0.9;
    margin-top: 4rem;
    padding: 2rem 0;
    text-align: center;
    font-style: italic;
  }

  .blog-footer p {
    margin: 0;
  }

  @media (max-width: 768px) {
    body {
      font-size: 16px;
    }

    .blog-container {
      padding: 0 1rem 2rem;
      max-width: 100%;
    }

    .blog-content {
      font-size: 0.95rem;
    }

    .blog-content h1 {
      font-size: 1.5rem;
      margin-top: 1.5rem;
    }

    .blog-content h2 {
      font-size: 1.3rem;
      margin-top: 2rem;
    }

    .blog-content h3 {
      font-size: 1.1rem;
      margin-top: 1.5rem;
    }

    .blog-content img {
      margin: 1rem 0;
      border-radius: 4px;
    }

    .blog-content code {
      font-size: 0.85em;
      padding: 0.15rem 0.3rem;
    }

    .blog-content pre {
      padding: 0.75rem;
      margin: 1rem -1rem;
      border-radius: 0;
    }

    .blog-content table {
      font-size: 0.85rem;
    }

    .blog-header {
      padding: 1.5rem 1rem 0.5rem;
    }

    .blog-header .site-name {
      font-size: 0.75rem;
    }

    .blog-footer {
      padding: 1.5rem 1rem;
      font-size: 0.85rem;
    }
  }
</style>

<script>
  // Prefetch links on hover for instant navigation
  document.addEventListener('DOMContentLoaded', function() {
    const prefetched = new Set();
    
    // Prefetch on hover
    document.addEventListener('mouseover', function(e) {
      const link = e.target.closest('a');
      if (!link || !link.href || link.href.startsWith('#') || prefetched.has(link.href)) return;
      
      // Only prefetch same-origin links
      if (new URL(link.href).origin !== location.origin) return;
      
      const prefetchLink = document.createElement('link');
      prefetchLink.rel = 'prefetch';
      prefetchLink.href = link.href;
      prefetchLink.as = 'document';
      document.head.appendChild(prefetchLink);
      prefetched.add(link.href);
    });
  });
  
  // Create and register service worker inline
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      const swCode = `
        const CACHE_NAME = 'ata-soy-v1';
        const urlsToCache = ['/', '/index.html', '/blogs.html', '/projects.html', '/library.html', '/nerdfolio.css'];
        
        self.addEventListener('install', function(event) {
          event.waitUntil(caches.open(CACHE_NAME).then(function(cache) { return cache.addAll(urlsToCache); }));
        });
        
        self.addEventListener('fetch', function(event) {
          event.respondWith(
            caches.match(event.request).then(function(response) {
              if (response) return response;
              return fetch(event.request).then(function(response) {
                if (!response || response.status !== 200 || response.type !== 'basic' || event.request.method !== 'GET') {
                  return response;
                }
                const responseToCache = response.clone();
                caches.open(CACHE_NAME).then(function(cache) { cache.put(event.request, responseToCache); });
                return response;
              });
            })
          );
        });
        
        self.addEventListener('activate', function(event) {
          const cacheWhitelist = [CACHE_NAME];
          event.waitUntil(
            caches.keys().then(function(cacheNames) {
              return Promise.all(cacheNames.map(function(cacheName) {
                if (cacheWhitelist.indexOf(cacheName) === -1) return caches.delete(cacheName);
              }));
            })
          );
        });
      `;
      
      const blob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl).catch(function() {});
    });
  }
</script>
</head>
<body>


<header class="blog-header">
  <a href="../index.html" style="display: inline-block;">
    <h1 class="site-name" style="margin: 0;">ata.soy</h1>
  </a>
</header>

</p>
<p><div style="text-align: center; padding: 2rem 1rem 3rem;">
  <h1 style="font-size: clamp(1.5rem, 5vw, 2.5rem); font-weight: 700; margin: 0 0 1.5rem 0; line-height: 1.2; padding: 0 0.5rem; word-wrap: break-word;">How I Handled Large File Uploads in a Serverless Next.js App</h1>
  <div style="display: flex; justify-content: center; gap: 1rem; font-size: clamp(0.75rem, 2vw, 0.9rem); opacity: 0.8; flex-wrap: wrap; padding: 0 1rem;">
    <span>June 1, 2025</span>
    <span>•</span>
    <span>3 min read</span>
    <span>•</span>
    <span>Ata Atasoy</span>
  </div>
</div>

</p>
<p><div style="width: 100%; max-width: 800px; margin: 0 auto 2rem; padding: 0 1rem;">
  <img src="../public/how-i-handled-large-file-uploads-in-serverless-nextjs/banner.png" alt="How I Handled Large File Uploads in a Serverless Next.js App" style="width: 100%; height: auto; border-radius: 8px; display: block; object-fit: cover; max-width: 100%; background: none !important;">
</div>

</p>
<p><div class="blog-container" style="width: 100%; max-width: 800px;">
<article class="blog-content">

</p>
<h2>Introduction</h2>
<p>In my latest project, <a href="https://fourgpa.com">fourgpa.com</a>, I needed to upload large PDF files to the OpenAI Files API for later reference and PDF processing. Everything worked perfectly in my local environment, even files up to the 30MB limit set by OpenAI.</p>
<p>But as soon as I deployed the app to Vercel, things started breaking - even with files as small as 5MB!</p>
<p>After some debugging, I finally tracked down the root cause of the issue and found a quick workaround.</p>
<p>Here is how I fixed it.</p>
<h2>Problem Definition</h2>
<p>I was transferring the file uploaded on the client to the server, and then uploading it to OpenAI using Server Actions. This setup worked fine locally after I updated my <code>next.config.ts</code> to allow a higher body size.</p>
<p>However, once I deployed it to Vercel, things broke. Vercel has a <a href="https://vercel.com/docs/functions/limitations#request-body-size">request body size limit</a> of 4.5MB for serverless functions, and I started getting the funny <code>413: FUNCTION_PAYLOAD_TOO_LARGE</code> error.</p>
<p>Here's what my original workflow looked like:</p>
<p><img src="../public/how-i-handled-large-file-uploads-in-serverless-nextjs/arch1.png" alt="Architecture diagram showing client to server to OpenAI flow"></p>
<p>But this has some fatal issues:</p>
<ol>
<li>Uploading files on the server is expensive - especially on serverless platforms :D</li>
<li>The file was being uploaded <strong>twice</strong>: once to my server and again to OpenAI</li>
<li>Files larger than <strong>4.5MB</strong> hit Vercel's body size limit, causing a <code>413: FUNCTION_PAYLOAD_TOO_LARGE</code> error</li>
</ol>
<h3>So… how did I solve this?</h3>
<p>I had to do the uploading on the client so it's free for my servers :). I couldn't upload directly to OpenAI from the client since it requires your secret key, so the only option left was using a middleman for file uploads.</p>
<p>Vercel Blob is a great option for this, but since I was already using Supabase S3, I just used it as cache storage and provided a calculated link as a parameter for server-side uploading to OpenAI.</p>
<p>But with this approach, since we are uploading from the client, we need to consider security. That's where <strong>signed URLs</strong> come in.</p>
<p>So here is what it looks like:</p>
<ol>
<li>Client → Server: Can I upload to documents/file.pdf?
Server → Client: Here's a signed URL (expires in 15min)</li>
<li>Client → S3: Upload file using signed URL
S3 → Client: Upload successful</li>
<li>Client → Server: What's the public URL for documents/file.pdf?
Server → Client: Here's the public URL: https://...</li>
<li>Client → Server: &quot;Process this file at public URL: https://...&quot;
Server: Downloads from public URL → Processes (sends to OpenAI) → Saves to DB</li>
</ol>
<p><img src="../public/how-i-handled-large-file-uploads-in-serverless-nextjs/arch2.png" alt="Architecture diagram showing client to S3 to server to OpenAI flow"></p>
<h2>Conclusion</h2>
<p>Probably this is not the best way to do all of this, but this solution was cheap and fast for me to implement :D. Maybe things would have been easier if I had an <strong>actual</strong> server instead of these limited serverless functions.</p>
<p>I get that serverless can be perfect for scalability, but my user count is literally 0 right now :). When I eventually have some users, paying for a small server to scale vertically won't be a problem.</p>
<p>Maybe the real question is: <em>What are we even optimizing for in the first place?</em></p>
<p></article>
</div>
</body>
</html>

</p>
<p><footer class="blog-footer">
  <p style="line-height: 1.6; word-wrap: break-word;">Have questions or feedback? Feel free to <a href="mailto:ataatasoy2013@gmail.com">email me</a> or connect with me on <a href="https://www.linkedin.com/in/ata-atasoy-67b496209/" target="_blank" rel="noopener">LinkedIn</a>.</p>
</footer>

</p>
